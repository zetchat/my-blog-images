

# 问题

```Mermaid
sequenceDiagram
    autonumber
    
    %% 定义参与者并进行分组配色
    box "用户/接入层" #f9f9f9
        participant FE as 前端 (Frontend)
        participant CTL as Controller层
    end
    
    box "核心业务层 (Core)" #eaeaea
        participant SVC as Service层
        participant BO as BO (业务领域对象)
    end
    
    box "基础设施层 (Infra)" #dedede
        participant DAO as DAO/Mapper层
        participant DB as 数据库 (DB)
    end

    %% --- 阶段1: 入参处理 ---
    Note over FE, CTL: 阶段: 请求接收与校验
    FE->>CTL: 1. 发送 JSON Request
    activate CTL
    
    CTL->>CTL: 2. @Valid 参数校验
    
    opt [复用场景] 多接口复用Service逻辑
        Note right of CTL: 仅在多个 Controller 入口<br/>聚合调用同一 Service 时使用
        CTL->>CTL: 3. 将 Req 转换为 Param/DTO
    end

    %% --- 阶段2: 核心业务 ---
    CTL->>SVC: 4. 调用 Service (传 Param 或 Req)
    activate SVC
    
    Note over SVC, BO: 阶段: 核心业务逻辑
    
    opt [复杂场景] 需要领域驱动设计(DDD) / 充血模型
        Note right of SVC: 简单增删改查可跳过此步<br/>直接在 Service 处理
        SVC->>BO: 5. 将 Param 转为 BO
        activate BO
        SVC->>BO: 6. 执行 bo.calculatePrice()
        BO->>BO: 内部策略/优惠券计算
        BO-->>SVC: 7. 返回处理后的数据
        deactivate BO
    end

    %% --- 阶段3: 持久化 ---
    SVC->>SVC: 8. 将 BO/Param 转为 DO (Entity)
    
    Note over SVC, DB: 阶段: 数据持久化
    SVC->>DAO: 9. 调用 Mapper 接口
    activate DAO
    DAO->>DB: 10. 执行 SQL (Insert/Update)
    activate DB
    DB-->>DAO: 11. 返回数据 / 影响行数
    deactivate DB
    DAO-->>SVC: 12. 返回 DO (Entity)
    deactivate DAO

    %% --- 阶段4: 出参封装 (关键优化点) ---
    Note over CTL, SVC: 阶段: 响应封装 (防腐层)
    
    rect rgb(255, 255, 240)
        Note right of SVC: 关键: 在此处将 DO 转为 DTO/VO <br/>不要把 DO 泄露给 Controller
        SVC->>SVC: 13. 将 DO 转为 DTO/VO
    end
    
    SVC-->>CTL: 14. 返回 DTO 数据
    deactivate SVC

    CTL->>CTL: 15. 封装统一响应 (Result&lt;T&gt;)
    CTL-->>FE: 16. 返回 JSON Response
    deactivate CTL
```

